# Handoff: Bug Eye/Mosaic Keyboard Fixes

**Date:** 2026-01-18
**Status:** In Progress - Testing Required

## Summary

Fixed keyboard handling for Bug Eye and Mosaic modes, particularly in fullscreen. Added Sets panel keyboard navigation. Fixed Mosaic stream updates with arrow keys.

## Changes Made

### 1. Keyboard Event Propagation (stream.js)

**Problem:** In true fullscreen, Escape and B keys weren't reaching app.js handlers because stream.js intercepted them.

**Fix:** Updated `propagateKeys` regex at line ~1967 to include Escape and B:
```javascript
const propagateKeys = /^[0-9]$/.test(e.key) || e.key.startsWith('Arrow') || /^[,.<>/?bB]$/.test(e.key) || e.key === 'Escape';
```

Also removed the local Escape case from the switch statement (now just a comment) since Escape is dispatched to document.

### 2. Capture-Phase Escape Handler (app.js)

**Added:** New capture-phase event listener (~line 862) that handles Escape with highest priority:
- Checks `bugEyeMode` first - closes Bug Eye
- Checks `mosaicMode` second - closes Mosaic
- Uses `stopImmediatePropagation()` to prevent other handlers

### 3. toggleMosaicMode forceOff Pattern (app.js)

**Problem:** Shift+B sometimes "redrew" mosaic instead of closing it (double-toggle issue).

**Fix:** Changed `toggleMosaicMode()` to use same pattern as `toggleBugEyeMode()`:
```javascript
function toggleMosaicMode(forceOff = false) {
    if (forceOff || mosaicMode) {
        // Turn off
        destroyMosaicOverlay();
        return;
    }
    // Turn on...
}
```

### 4. Mosaic Stream Tracking (app.js)

**Added:** `mosaicStreamId` variable to track which stream is shown in mosaic:
- Set in `createMosaicOverlay()`
- Reset in `destroyMosaicOverlay()`
- Checked in `updateBugEyeIfNeeded()` to detect stream changes

### 5. updateBugEyeIfNeeded Now Handles Mosaic (app.js)

**Problem:** Arrow keys didn't update Mosaic to show new stream.

**Fix:** Extended function to handle both modes:
```javascript
function updateBugEyeIfNeeded() {
    // Update Bug Eye if active
    if (bugEyeMode && targetStream.id !== bugEyeStreamId) {
        createBugEyeOverlay(targetStream);
    }
    // Update Mosaic if active
    if (mosaicMode && targetStream.id !== mosaicStreamId) {
        destroyMosaicOverlay();
        mosaicMode = true; // Keep mode on
        createMosaicOverlay(targetStream);
    }
}
```

### 6. Sets Panel Keyboard Navigation (app.js)

**Added:** Arrow key navigation and Enter to load in Sets panel:
- `selectedSetIndex` state variable
- `handleSetsPanelKeyboard()` function
- `updateSetSelection()` for visual feedback
- Called at start of `handleKeyboard()`

### 7. CSS: Sets Panel Selection (plexd.css)

**Added:**
```css
.plexd-combo-item.plexd-combo-selected {
    background: #3a3a3a;
    outline: 2px solid #3b82f6;
    outline-offset: -2px;
}
```

## Known Issues / Testing Needed

1. **Escape in true fullscreen** - Browser intercepts first Escape to exit fullscreen before JS handlers run. This is unavoidable browser security behavior. Second Escape should close Bug Eye/Mosaic.

2. **Shift+B dismiss** - Debug logging added at line ~2636. Check console output when pressing Shift+B to verify `mosaicMode` value.

3. **Variable scoping** - `mosaicMode` is declared at line ~1517 but referenced in capture handler at line ~877. Should work via closure but worth verifying.

### 8. Arrow Keys in True-Grid Mode (app.js)

**Problem:** Arrow keys in fullscreen grid mode were entering focus mode instead of just changing selection.

**Fix:** Changed `handleArrowNav` for `true-grid` mode to call `selectNextStream()` instead of `enterFocusedMode()`.

## Files Modified

| File | Changes |
|------|---------|
| `web/js/stream.js` | propagateKeys includes Escape/B, removed Escape switch case |
| `web/js/app.js` | Capture Escape handler, toggleMosaicMode forceOff, mosaicStreamId, updateBugEyeIfNeeded handles mosaic, Sets keyboard nav, true-grid arrow fix |
| `web/css/plexd.css` | Sets selection styling |
| `web/index.html` | Version bump to v61 |

## Debug Logging (Remove After Testing)

- Line ~2636 in app.js: `[Plexd] B key: shiftKey=..., mosaicMode=..., bugEyeMode=...`

## Test Checklist

- [ ] B toggles Bug Eye on/off (all modes: grid, focus, fullscreen)
- [ ] Shift+B toggles Mosaic on/off (all modes)
- [ ] Escape closes Bug Eye before exiting fullscreen
- [ ] Escape closes Mosaic before exiting fullscreen
- [ ] Arrow keys change stream while in Bug Eye
- [ ] Arrow keys change stream while in Mosaic
- [ ] Sets panel: Arrow up/down navigates
- [ ] Sets panel: Enter loads selected set
- [ ] D key opens Sets panel
